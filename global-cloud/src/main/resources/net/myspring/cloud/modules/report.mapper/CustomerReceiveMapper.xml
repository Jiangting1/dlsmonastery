<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="net.myspring.cloud.modules.report.mapper.CustomerReceiveMapper">
    <select id="findByEndDate" resultType="CustomerReceiveDto">
        SELECT
        h.customerId,
        SUM (h.beginAmount) AS beginAmount
        FROM
        (
        SELECT
        b.FCONTACTUNIT AS customerId,
        a.FAMOUNT AS beginAmount
        FROM
        T_AR_OTHERRECABLEENTRY a
        JOIN T_AR_OTHERRECABLE b ON a.FID = b.FID
        JOIN T_BD_CUSTOMER e on e.FCUSTID = b.FCONTACTUNIT
        WHERE
        b.FDATE &lt;#{dateEnd}
        and e.FPRIMARYGROUP = #{primaryGroup}
        UNION ALL
        SELECT
        b.FRETCUSTID AS customerId,
        - c.FAMOUNT AS beginAmount
        FROM
        T_SAL_RETURNSTOCKENTRY a
        JOIN T_SAL_RETURNSTOCK b ON a.FID = b.FID
        JOIN T_SAL_RETURNSTOCKENTRY_F c ON b.FID = c.FID  AND a.FENTRYID = c.FENTRYID
        JOIN T_BAS_BILLTYPE_L d ON d.FBILLTYPEID = b.FBILLTYPEID
        JOIN T_BD_CUSTOMER e on e.FCUSTID = b.FRETCUSTID
        WHERE
        d.FNAME = '标准销售退货单'
        and b.FDATE &lt;#{dateEnd}
        and e.FPRIMARYGROUP = #{primaryGroup}
        UNION ALL
        SELECT
        b.FCUSTOMERID AS customerId,
        c.FALLAMOUNT AS beginAmount
        FROM
        T_SAL_OUTSTOCKENTRY a
        JOIN T_SAL_OUTSTOCK b ON a.FID = b.FID
        JOIN T_SAL_OUTSTOCKENTRY_F c ON a.FID = c.FID AND a.FENTRYID = c.FENTRYID
        JOIN T_BAS_BILLTYPE_L d ON b.FBILLTYPEID = d.FBILLTYPEID
        JOIN T_BD_CUSTOMER e ON e.FCUSTID = b.FCUSTOMERID
        WHERE
        d.FNAME = '标准销售出库单'
        and b.FDATE &lt;#{dateEnd}
        and e.FPRIMARYGROUP = #{primaryGroup}
        UNION ALL
        SELECT
        b.FCONTACTUNIT AS customerId,
        - a.FRECAMOUNT_E AS beginAmount
        FROM
        T_AR_RECEIVEBILLENTRY a
        JOIN T_AR_RECEIVEBILL b ON a.FID = b.FID
        JOIN T_BD_CUSTOMER e ON e.FCUSTID = b.FCONTACTUNIT
        WHERE
        b.FDATE &lt;#{dateEnd}
        and e.FPRIMARYGROUP = #{primaryGroup}
        UNION ALL
        SELECT
        b.FCONTACTUNIT AS customerId,
        a.FREALREFUNDAMOUNTFOR AS beginAmount
        FROM
        T_AR_REFUNDBILLENTRY a
        JOIN T_AR_REFUNDBILL b ON b.FID = a.FID
        JOIN T_BD_CUSTOMER e ON e.FCUSTID = b.FCONTACTUNIT
        WHERE
        b.FDATE &lt;#{dateEnd}
        and e.FPRIMARYGROUP = #{primaryGroup}
        ) h
        GROUP BY
        h.customerId
    </select>

    <select id="findByEndDateAndIn" resultType="CustomerReceiveDto">
        SELECT
        h.customerId,
        SUM (h.beginAmount) AS beginAmount
        FROM
        (
        SELECT
        b.FCONTACTUNIT AS customerId,
        a.FAMOUNT AS beginAmount
        FROM
        T_AR_OTHERRECABLEENTRY a
        JOIN T_AR_OTHERRECABLE b ON a.FID = b.FID
        WHERE
        b.FDATE &lt;#{dateEnd}
        and b.FCONTACTUNIT in
        <foreach collection="customerIdList" item="item" index="index" open="(" separator="," close=")">
            #{item}
        </foreach>
        UNION ALL
        SELECT
        b.FRETCUSTID AS customerId,
        - c.FAMOUNT AS beginAmount
        FROM
        T_SAL_RETURNSTOCKENTRY a
        JOIN T_SAL_RETURNSTOCK b ON a.FID = b.FID
        JOIN T_SAL_RETURNSTOCKENTRY_F c ON b.FID = c.FID  AND a.FENTRYID = c.FENTRYID
        LEFT JOIN T_BAS_BILLTYPE_L d ON d.FBILLTYPEID = b.FBILLTYPEID
        WHERE
        d.FNAME = '标准销售退货单'
        and b.FDATE &lt;#{dateEnd}
        and b.FRETCUSTID in
        <foreach collection="customerIdList" item="item" index="index" open="(" separator="," close=")">
            #{item}
        </foreach>
        UNION ALL
        SELECT
        b.FCUSTOMERID AS customerId,
        c.FALLAMOUNT AS beginAmount
        FROM
        T_SAL_OUTSTOCKENTRY a
        JOIN T_SAL_OUTSTOCK b ON a.FID = b.FID
        JOIN T_SAL_OUTSTOCKENTRY_F c ON a.FID = c.FID AND a.FENTRYID = c.FENTRYID
        LEFT JOIN T_BAS_BILLTYPE_L d ON b.FBILLTYPEID = d.FBILLTYPEID
        WHERE
        d.FNAME = '标准销售出库单'
        and b.FDATE &lt;#{dateEnd}
        and b.FCUSTOMERID in
        <foreach collection="customerIdList" item="item" index="index" open="(" separator="," close=")">
            #{item}
        </foreach>
        UNION ALL
        SELECT
        b.FCONTACTUNIT AS customerId,
        - a.FRECAMOUNT_E AS beginAmount
        FROM
        T_AR_RECEIVEBILLENTRY a
        JOIN T_AR_RECEIVEBILL b ON a.FID = b.FID
        WHERE
        b.FDATE &lt;#{dateEnd}
        and b.FCONTACTUNIT in
        <foreach collection="customerIdList" item="item" index="index" open="(" separator="," close=")">
            #{item}
        </foreach>
        UNION ALL
        SELECT
        b.FCONTACTUNIT AS customerId,
        a.FREALREFUNDAMOUNTFOR AS beginAmount
        FROM
        T_AR_REFUNDBILLENTRY a
        JOIN T_AR_REFUNDBILL b ON b.FID = a.FID
        WHERE
        b.FDATE &lt;#{dateEnd}
        and b.FCONTACTUNIT in
        <foreach collection="customerIdList" item="item" index="index" open="(" separator="," close=")">
            #{item}
        </foreach>
        ) h
        GROUP BY
        h.customerId
    </select>

</mapper>
