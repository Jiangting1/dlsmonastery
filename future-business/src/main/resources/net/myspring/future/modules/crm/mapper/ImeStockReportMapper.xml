<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="net.myspring.future.modules.crm.mapper.ImeStockReportMapper">

    <select id="findOfficeStockDataReport" resultType="ImeStockReport">
        select
        <if test="p.levelDiff!=null and p.levelDiff!=0">
            office${p.levelDiff}.id as 'key',
            office${p.levelDiff}.name as 'value',
        </if>
        <if test="p.levelDiff==null or p.levelDiff==0">
            t1.office_id as 'key',
            office.name as 'value',
        </if>
        t1.report_type,
        sum(t1.sale_stock) as sale_stock,
        sum(t1.town_stock) as town_stock,
        sum(t1.county_stock) as county_stock,
        sum(t1.city_stock) as city_stock,
        sum(t1.yidong_stock) as yidong_stock,
        sum(t1.lianxin_stock) as lianxin_stock,
        sum(t1.quanwangtong_stock) as quanwangtong_stock
        from
        crm_ime_stock_report t1,
        hr_office office
        <if test="p.levelDiff!=null and p.levelDiff!=0">
            <foreach collection="p.levelDiffList" index="index" item="item" open="," separator="," close="">
                hr_office office${item}
            </foreach>
        </if>
        where
        t1.enabled =1
        and t1.office_id = office.id
        <if test="p.levelDiff!=null and p.levelDiff!=0">
            and office${p.levelDiff}.type=#{p.officeType}
            and office.parent_id=office1.id
            <foreach collection="p.levelDiffList" index="index" item="item" open="" separator="" close="">
                <if test="item!=p.levelDiff">
                    and office${item}.parent_id=office${item+1}.id
                </if>
            </foreach>
        </if>
        <if test="p.parentOfficeId!=null">
            and office.parent_ids like CONCAT('%,',#{p.parentOfficeId},',%')
        </if>
        and t1.report_date = DATE_FORMAT(#{p.reportDateEnd},"%Y-%m-%d")
        <include refid="net.myspring.future.modules.hr.mapper.OfficeMapper.officeFilter"/>
        <if test="p.levelDiff!=null and p.levelDiff!=0">
            group by office${p.levelDiff}.id,t1.report_type
        </if>
        <if test="p.levelDiff==null or p.levelDiff==0">
            group by office.id,t1.report_type
        </if>
    </select>

    <select id="findProductStockDataReport" resultType="ImeStockReport">
        select
        <if test="p.productTypeId !=null">
            t1.product_id as 'key',
            p.name as 'value',
        </if>
        <if test="p.productTypeId ==null">
            pty.id as 'key',
            pty.name as 'value',
        </if>
        t1.report_type,
        sum(t1.sale_stock) as sale_stock,
        sum(t1.town_stock) as town_stock,
        sum(t1.county_stock) as countystock,
        sum(t1.city_stock) as city_stock,
        sum(t1.yidong_stock) as yidong_stock,
        sum(t1.lianxin_stock) as lianxin_stock,
        sum(t1.quanwangtong_stock) as quanwangtong_stock
        from
        crm_ime_stock_report t1,
        crm_product p,
        crm_product_type pty,
        hr_office office
        where
        t1.enabled =1
        and t1.product_id=p.id
        and t1.office_id=office.id
        and p.product_type_id=pty.id
        and p.enabled=1
        and p.has_ime=1
        and pty.enabled=1
        <if test="p.productTypeId !=null">
            and pty.id=#{p.productTypeId}
        </if>
        <if test="p.productName !=null ">
            and p.name like CONCAT('%',#{p.productName},'%')
            )
        </if>
        and t1.report_date = DATE_FORMAT(#{p.reportDateEnd},"%Y-%m-%d")
        <include refid="net.myspring.future.modules.hr.mapper.OfficeMapper.officeFilter"/>
        <if test="p.productTypeId !=null">
            group by t1.product_id,t1.report_type
        </if>
        <if test="p.productTypeId ==null">
            group by pty.id,t1.report_type
        </if>
    </select>

</mapper>
