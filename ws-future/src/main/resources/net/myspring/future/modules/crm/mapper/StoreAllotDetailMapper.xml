<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="net.myspring.future.modules.crm.mapper.StoreAllotDetailMapper">

    <select id="findByStoreAllotIds" resultType="StoreAllotDetailDto">
      SELECT product.name productName, product.out_id outId, product.has_ime productHasIme, 0 shipQty, t1.*
       from crm_store_allot_detail t1, crm_product product
        where t1.product_id = product.id
        and  t1.store_allot_id in
        <foreach collection="list" item="item" index="index" open="(" separator="," close=")">
            #{item}
        </foreach>

        ORDER BY t1.store_allot_id, product.has_ime DESC

    </select>

    <select id="findStoreAllotDetailsForFastAllot" resultType="SimpleStoreAllotDetailDto">
        SELECT result.productId productId, SUM(result.billQty) billQty
        FROM
            (
                ( SELECT detail.product_id productId, SUM(detail.bill_qty) billQty
                  FROM  crm_goods_order_detail detail
                  WHERE detail.goods_order_id IN ( SELECT t1.id FROM  crm_goods_order t1 WHERE t1.bill_date = #{billDate} AND t1.store_id = #{toStoreId} AND t1. STATUS = #{status} AND t1.enabled = 1 )
                  GROUP BY detail.product_id  )
               UNION ALL
                ( SELECT  ime.product_id productId, COUNT(*) billQty
                  FROM crm_goods_order_ime ime
                  WHERE  ime.goods_order_id IN ( SELECT t2.id FROM  crm_goods_order t2 WHERE t2.bill_date = #{billDate} AND t2.store_id = #{toStoreId} AND t2. STATUS = #{status} AND t2.enabled = 1 )
                  GROUP BY ime.product_id )
                UNION ALL
                ( SELECT  t1.id productId, 0 billQty
                  FROM crm_product t1
                  WHERE  t1.enabled=1 AND t1.company_id = #{companyId} )
            ) result
        GROUP BY result.productId
        ORDER BY result.billQty DESC
    </select>

    <select id="findStoreAllotDetailListForNew" resultType="SimpleStoreAllotDetailDto">

        select t1.id productId
        from crm_product t1
        where  t1.enabled=1
                   AND t1.company_id = #{companyId}

    </select>



    <delete id="deleteByStoreAllotId" >
        DELETE FROM crm_store_allot_detail where store_allot_id = #{storeAllotId}
    </delete>





</mapper>
