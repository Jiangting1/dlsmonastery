<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="net.myspring.future.modules.basic.mapper.DepotShopMapper">

    <select id="findDepotDtoList" resultType="DepotDto">
        SELECT t1.*
        FROM crm_depot depot ,crm_depot_shop t2
        where depot.depot_shop_id=t2.id
        and depot.enabled=1
        and t2.enabled=1
        <if test="p.direct">
            and t2.client_id is not NULL
            and t2.client_id in (
                SELECT id
                FROM crm_client
                where enabled=1
                and out_id is not NULL
            )
        </if>
        <if test="p.delegate">
            and depot.client_id is NULL
        </if>
        <if test="p.directAndSub">
           and t2.client_id is not NULL
        </if>
        and depot.name like concat('%',#{p.key},'%')
        <include refid="depotFilter" />
    </select>

    <select id="findPage" resultType="DepotShopDto">
        SELECT t1.*,t2.*
        FROM crm_depot depot ,crm_depot_shop t2
        where depot.denabled=1
        and t2.enabled=1
        and depot.depot_shop_id=t2.id
    </select>

    <sql id="depotFilter">
    <if test="p.officeIdList !=null and p.officeIdList.size() !=0">
        and depot.office_id IN
        <foreach collection="p.officeIdList" index="index" item="item" open="(" separator="," close=")">
            #{p.officeIdList[${index}]}
        </foreach>
    </if>
    <if test="p.depotIdList !=null and p.depotIdList.size() !=0">
        and depot.id IN
        <foreach collection="p.depotIdList" index="index" item="item" open="(" separator="," close=")">
            #{p.depotIdList[${index}]}
        </foreach>
    </if>
</sql>
</mapper>
