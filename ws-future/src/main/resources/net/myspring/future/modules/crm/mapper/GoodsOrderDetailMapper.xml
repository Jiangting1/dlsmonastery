<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="net.myspring.future.modules.crm.mapper.GoodsOrderDetailMapper">

    <select id="findByGoodsOrderId" resultType="GoodsOrderDetail">
        SELECT t1.*
        FROM crm_goods_order_detail t1
        WHERE t1.goods_order_id=#{goodsOrderId}
    </select>


    <select id="getDtoListForNewWithoutAreaQty" resultType="GoodsOrderDetailDto">
        SELECT
            t2.product_id,
            t3.name productName,
            t3.has_ime productHasIme,
            t3.allow_order productAllowOrder,
            t3.allow_bill productAllowBill
        FROM
            crm_depot t1,
            crm_pricesystem_detail t2,
            crm_product t3
        WHERE
            t1.id = #{depotId}
        AND t1.pricesystem_id = t2.pricesystem_id
        AND t2.product_id = t3.id
        AND t3.enabled = 1
        AND (
            '全网通' = #{netType}
            OR t3.net_type = '全网通'
            OR t3.net_type = #{netType}
        )
        AND( #{showAll} OR (t3.allow_order = 1 and t3.allow_bill = 1)  )
    </select>


    <select id="getDtoWithAreaQty" resultType="GoodsOrderDetailDto">
        SELECT
            t1.price,
            t2.has_ime productHasIme,
            t2.id productId,
            t2.name productName,
            t2.allow_order productAllowOrder,
            t2.allow_bill productAllowBill,
            (
                SELECT
                    SUM(innerDetail.qty)
                FROM
                    crm_goods_order_detail innerDetail,
                    crm_goods_order innerOrd,
                    crm_depot innerDepot
                WHERE
                    innerDetail.product_id = #{productId}
                AND innerDetail.goods_order_id = innerOrd.id
                AND innerOrd.enabled = 1
                AND innerOrd.created_date >= #{dateStart}
                AND innerOrd.created_date &lt; #{dateEnd}
                AND innerOrd.shop_id = innerDepot.id
                AND innerDepot.enabled = 1
                AND innerDepot.area_id = t3.area_id
            ) areaQty
        FROM
            crm_pricesystem_detail t1,
            crm_product t2,
            crm_depot t3
        WHERE
            t3.id = #{depotId}
        AND t1.pricesystem_id = t3.pricesystem_id
        AND t1.product_id = #{productId}
        AND t1.product_id = t2.id
    </select>



    <select id="findByGoodsOrderIds" resultType="GoodsOrderDetail">
        SELECT t1.*
        FROM crm_goods_order_detail t1
        WHERE t1.goods_order_id IN
        <foreach collection="list" index="index" item="item" open="(" separator="," close=")">
            #{item}
        </foreach>
    </select>

    <select id="findByParentOfficeIdAndCreatedDate" resultType="GoodsOrderDetail">
        SELECT t1.*
         FROM crm_goods_order_detail t1,crm_goods_order t2 ,crm_depot t3
          where t3.enabled=1
          and t2.enabled=1
          and t1.goods_order_id=t2.id
          and t2.shop_id=t3.id
          and t3.area_id=#{areaId}
          and t2.created_date &gt;= #{dateStart}
          and t2.created_date &lt;= #{dateEnd}
    </select>

    <select id="findByParentOfficeIdAndBillDate" resultType="GoodsOrderDetail">
         SELECT t1.*
         FROM crm_goods_order_detail t1,crm_goods_order t2 ,crm_depot t3
          where t3.enabled=1
          and t2.enabled=1
          and t1.goods_order_id=t2.id
          and t2.shop_id=t3.id
          and t3.area_id=#{areaId}
          and t2.bill_date &gt;= #{dateStart}
          and t2.bill_date &lt;= #{dateEnd}
          and t2.ship_type in
          <foreach collection="shipTypes" item="item" index="index" open="(" separator="," close=")">
              #{item}
          </foreach>
    </select>

</mapper>
