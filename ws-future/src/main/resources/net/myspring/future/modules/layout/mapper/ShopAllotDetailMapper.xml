<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="net.myspring.future.modules.layout.mapper.ShopAllotDetailMapper">


    <select id="findByShopAllotId" resultType="ShopAllotDetail">
        select t1.* from crm_shop_allot_detail t1 where t1.shop_allot_id  = #{shopAllotId}
    </select>

    <select id="getShopAllotDetailListForEdit" resultType="ShopAllotDetailDto">

        select validProduct.id productId, validProduct.productName productName, detail.*
        from  (select t1.id id, t1.name productName
                    from crm_product t1
                    where t1.id in (select t2.product_id from crm_pricesystem_detail t2 where t2.pricesystem_id = (select depot1.pricesystem_id from crm_depot depot1 where depot1.id = #{fromShopId}))
                    and t1.id in (select t3.product_id from crm_pricesystem_detail t3 where t3.pricesystem_id =  (select depot2.pricesystem_id from crm_depot depot2 where depot2.id = #{toShopId}))
                    and t1.enabled=1) validProduct LEFT JOIN crm_shop_allot_detail detail
                    ON validProduct.id = detail.product_id
        where  detail.shop_allot_id = #{shopAllotId}

    </select>


    <select id="getShopAllotDetailListForNew" resultType="ShopAllotDetailDto">

        select t1.id productId, t1.name productName
        from crm_product t1
        where t1.id in (select t2.product_id from crm_pricesystem_detail t2 where t2.pricesystem_id = (select depot1.pricesystem_id from crm_depot depot1 where depot1.id = #{fromShopId}))
        and t1.id in (select t3.product_id from crm_pricesystem_detail t3 where t3.pricesystem_id =  (select depot2.pricesystem_id from crm_depot depot2 where depot2.id = #{toShopId}))
        and t1.enabled=1

    </select>


    <select id="findByShopAllotIds" resultType="ShopAllotDetail">
        SELECT  t1.* from crm_shop_allot_detail t1
        where t1.shop_allot_id IN
        <foreach collection="list" index="index" item="item" open="(" separator="," close=")">
            #{item}
        </foreach>
    </select>

    <delete id="deleteByShopAllotId" >
        DELETE FROM crm_shop_allot_detail where shop_allot_id = #{shopAllotId}
    </delete>

</mapper>
